name: Build SukiSU Ultra Kernel for Gauguinpro

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  KERNEL_NAME: SukiSU-Ultra-gauguinpro
  KERNEL_DIR: kernel
  ANY_KERNEL_DIR: AnyKernel3
  CONFIG: vendor/gauguin_defconfig

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:

    - name: Checkout LineageOS 23 Kernel
      run: |
        echo "üîß Cloning LineageOS 23 kernel source..."
        git clone -b lineage-23.0 --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_sm7125.git ${{ env.KERNEL_DIR }}
        echo "‚úÖ Kernel source cloned successfully"

    - name: Integrate SukiSU Ultra
      run: |
        cd ${{ env.KERNEL_DIR }}
        echo "üîß Running SukiSU Ultra setup script..."

        curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash - || true
        
        echo "üìã Setup script execution completed"
        echo "‚ÑπÔ∏è  Continuing build regardless of script result"

    - name: Get AnyKernel3
      uses: actions/checkout@v4
      with:
        repository: osm0sis/AnyKernel3
        path: ${{ env.ANY_KERNEL_DIR }}

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          git \
          zip \
          unzip \
          wget

        wget -qO- https://developer.arm.com/-/media/Files/downloads/gnu-a/10.3-2021.07/binrel/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu.tar.xz | tar -xJ
        echo "GCC_PATH=$(pwd)/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin" >> $GITHUB_ENV

    - name: Setup Environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-none-linux-gnu-" >> $GITHUB_ENV
        echo "PATH=$GCC_PATH:$PATH" >> $GITHUB_ENV

    - name: Build Kernel
      run: |
        cd ${{ env.KERNEL_DIR }}
        
        echo "üßπ Cleaning build directory..."
        make O=out clean && make O=out mrproper
        
        echo "‚öôÔ∏è Applying config: ${{ env.CONFIG }}"
        make O=out ${{ env.CONFIG }}

        echo "üîß Ensuring SukiSU is enabled..."
        if grep -q "CONFIG_SUKISU" out/.config; then
          sed -i 's/CONFIG_SUKISU=.*/CONFIG_SUKISU=y/' out/.config
          echo "‚úÖ SukiSU enabled in config"
        else
          echo "CONFIG_SUKISU=y" >> out/.config
          echo "‚úÖ SukiSU added to config"
        fi
        
        echo "üöÄ Starting kernel compilation..."
        make O=out -j$(nproc) \
          CROSS_COMPILE=aarch64-none-linux-gnu-

        if [ -f "out/arch/arm64/boot/Image.gz-dtb" ]; then
          echo "‚úÖ Kernel built successfully!"
          ls -lh out/arch/arm64/boot/Image.gz-dtb
        else
          echo "‚ùå Kernel build failed"
          echo "Debug info:"
          find out -name "*.o" | head -5
          exit 1
        fi

    - name: Package Kernel
      run: |
        echo "üì¶ Packaging kernel..."
        cp ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz-dtb ${{ env.ANY_KERNEL_DIR }}/
        
        cd ${{ env.ANY_KERNEL_DIR }}
        zip -r9 ../${{ env.KERNEL_NAME }}-$(date +%Y%m%d).zip .

    - name: Upload Kernel Zip
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_NAME }}
        path: ./*.zip
        retention-days: 30
