name: Build SukiSU Ultra Kernel for Gauguinpro

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  KERNEL_NAME: SukiSU-Ultra-gauguinpro
  KERNEL_DIR: kernel
  ANY_KERNEL_DIR: AnyKernel3
  CONFIG: vendor/gauguin_defconfig

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:

    - name: Download Kernel Source
      run: |
        echo "ðŸ”§ Downloading kernel source from direct link..."
        wget -O kernel.zip "https://github.com/LineageOS/android_kernel_xiaomi_gauguin/archive/refs/heads/lineage-23.0.zip"
        
        if [ -f "kernel.zip" ]; then
          echo "âœ… Kernel source downloaded, extracting..."
          unzip -q kernel.zip
          mv android_kernel_xiaomi_gauguin-lineage-23.0 ${{ env.KERNEL_DIR }}
          echo "âœ… Kernel source extracted to ${{ env.KERNEL_DIR }}"
        else
          echo "âŒ Kernel source download failed"
          exit 1
        fi

    - name: Integrate SukiSU Ultra
      run: |
        cd ${{ env.KERNEL_DIR }}
        echo "ðŸ”§ Running SukiSU Ultra setup script..."

        curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash - || true
        
        echo "ðŸ“‹ Setup script execution completed"

    - name: Get AnyKernel3
      run: |
        echo "ðŸ”§ Downloading AnyKernel3..."
        wget -O anykernel3.zip "https://github.com/osm0sis/AnyKernel3/archive/refs/heads/master.zip"
        unzip -q anykernel3.zip
        mv AnyKernel3-master ${{ env.ANY_KERNEL_DIR }}
        echo "âœ… AnyKernel3 downloaded and extracted"

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          git \
          zip \
          unzip \
          wget

        wget -qO- https://developer.arm.com/-/media/Files/downloads/gnu-a/10.3-2021.07/binrel/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu.tar.xz | tar -xJ
        echo "GCC_PATH=$(pwd)/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin" >> $GITHUB_ENV

    - name: Setup Environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-none-linux-gnu-" >> $GITHUB_ENV
        echo "PATH=$GITHUB_PATH:$GCC_PATH" >> $GITHUB_ENV

    - name: Build Kernel
      run: |
        cd ${{ env.KERNEL_DIR }}
        
        echo "ðŸ§¹ Cleaning build directory..."
        make O=out clean && make O=out mrproper
        
        echo "âš™ï¸ Applying config: ${{ env.CONFIG }}"
        make O=out ${{ env.CONFIG }}

        echo "ðŸ”§ Ensuring SukiSU is enabled..."
        if grep -q "CONFIG_SUKISU" out/.config; then
          sed -i 's/CONFIG_SUKISU=.*/CONFIG_SUKISU=y/' out/.config
          echo "âœ… SukiSU enabled in config"
        else
          echo "CONFIG_SUKISU=y" >> out/.config
          echo "âœ… SukiSU added to config"
        fi
        
        echo "ðŸš€ Starting kernel compilation..."
        make O=out -j$(nproc) \
          CROSS_COMPILE=aarch64-none-linux-gnu-

        if [ -f "out/arch/arm64/boot/Image.gz-dtb" ]; then
          echo "âœ… Kernel built successfully!"
          ls -lh out/arch/arm64/boot/Image.gz-dtb
          echo "ðŸ“Š File size: $(du -h out/arch/arm64/boot/Image.gz-dtb | cut -f1)"
        else
          echo "âŒ Kernel build failed - checking for output files..."
          find out/arch/arm64/boot/ -type f 2>/dev/null | head -10
          echo "ðŸ” Build log tail:"
          tail -50 out/.config || true
          exit 1
        fi

    - name: Package Kernel
      run: |
        echo "ðŸ“¦ Packaging kernel..."
        cp ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz-dtb ${{ env.ANY_KERNEL_DIR }}/
        
        # åˆ›å»º anykernel.sh è„šæœ¬
        cat > ${{ env.ANY_KERNEL_DIR }}/anykernel.sh << 'EOF'
        #!/system/bin/sh
        # AnyKernel3 Script for Gauguinpro
        
        block=/dev/block/bootdevice/by-name/boot;
        is_slot_device=0;
        ramdisk_compression=auto;
        
        . /tmp/anykernel/tools/ak3-core.sh;
        
        dump_boot;
        write_boot;
        EOF
        
        cd ${{ env.ANY_KERNEL_DIR }}
        zip -r9 ../${{ env.KERNEL_NAME }}-$(date +%Y%m%d-%H%M).zip .

    - name: Upload Kernel Zip
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_NAME }}
        path: ./*.zip
        retention-days: 30
