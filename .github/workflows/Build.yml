name: Build Kernel with KernelSU

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout kernel
      run: |
        git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_gauguin -b lineage-23.0 kernel
        cd kernel
        
    - name: Clone KernelSU
      run: |
        cd kernel
        git clone https://github.com/tiann/KernelSU.git --depth=1
        
    - name: Manual KernelSU integration
      run: |
        cd kernel
        
        echo "=== 手动集成 KernelSU ==="

        mkdir -p drivers/kernelsu

        cp -r KernelSU/kernel/* drivers/kernelsu/

        KERNEL_VERSION=$(grep -E "^VERSION|^PATCHLEVEL" Makefile | tr -d ' ' | cut -d= -f2 | tr '\n' '.' | sed 's/\.$//')
        echo "内核版本: $KERNEL_VERSION"

        if [ -f "KernelSU/kernel/patches/4.19.patch" ]; then
            echo "应用 4.19 补丁..."
            patch -p1 < KernelSU/kernel/patches/4.19.patch 2>&1 | grep -v "ignored" || echo "补丁可能有警告"
        fi

        if ! grep -q "kernelsu" drivers/Kconfig; then
            echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        fi

        if ! grep -q "kernelsu" drivers/Makefile; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile
        fi

        echo -e "\n# KernelSU\nCONFIG_KSU=y\nCONFIG_KSU_DEBUG=n" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        echo "CONFIG_KPROBES=y" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        echo "CONFIG_HAVE_KPROBES=y" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        echo "CONFIG_KPROBE_EVENTS=y" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        
    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y build-essential gcc-aarch64-linux-gnu libssl-dev bc flex bison libelf-dev python3
        
    - name: Build kernel
      run: |
        cd kernel
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "1. 配置内核..."
        make vendor/xiaomi/gauguin.config
        
        echo "2. 检查 KSU 配置..."
        grep -i ksu .config || echo "KSU 配置未找到"
        
        echo "3. 开始编译..."
        make -j$(nproc) 2>&1 | tee build.log
        
        if [ -f "arch/arm64/boot/Image" ]; then
            echo "✅ 编译成功!"
            ls -lh arch/arm64/boot/Image
        else
            echo "❌ 编译失败"
            grep -n "error:" build.log | head -20
            exit 1
        fi
        
    - name: Upload kernel
      uses: actions/upload-artifact@v4
      with:
        name: kernel-with-ksu
        path: kernel/arch/arm64/boot/Image
