name: Build Gauguin Kernel Properly

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04  # 使用22.04更稳定
    timeout-minutes: 180
   
    steps:
    - name: Checkout
      uses: actions/checkout@v4
     
    - name: Download config
      run: |
        curl -L -o config.txt "https://gamerminecraft.lanzouu.com/il3z23eyhihe"
        mv config.txt device.config
        echo "配置下载完成"
       
    - name: Clone kernel
      run: |
        git clone --depth=1 --branch lineage-23.0 \
          https://github.com/LineageOS/android_kernel_xiaomi_gauguin \
          kernel
         
    - name: Install Android build tools
      run: |
        # Ubuntu 22.04 基础包
        sudo apt update
        sudo apt install -y \
          build-essential \
          libncurses5-dev \
          libncursesw5-dev \
          bc \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          lz4 \
          lzop \
          python3 \
          git \
          wget \
          curl \
          xxd
       
        # 安装Android专用交叉编译器
        echo "安装Android工具链..."
        wget -q https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/android-13.0.0_r41.tar.gz
        mkdir -p /opt/aarch64-linux-android-4.9
        tar -xzf android-13.0.0_r41.tar.gz -C /opt/aarch64-linux-android-4.9
       
        # 安装32位兼容库（某些内核需要）
        sudo apt install -y gcc-multilib
       
    - name: Prepare configuration
      run: |
        cd kernel
       
        # 使用device.config作为基础
        cp ../device.config .config
       
        # 清理配置格式
        sed -i '/^$/d' .config
        sed -i '/^#.*$/d' .config  # 先删除所有注释
       
        # 启用基本选项（先只启用最关键的）
        echo "" >> .config
        echo "# Essential for KernelSU" >> .config
        echo "CONFIG_KPROBES=y" >> .config
        echo "CONFIG_MODULES=y" >> .config
        echo "CONFIG_OVERLAY_FS=y" >> .config
       
        # 去重
        awk '!seen[$1]++' .config > .config.tmp
        mv .config.tmp .config
       
        echo "配置准备完成"
       
    - name: Fix common config issues
      run: |
        cd kernel
       
        # 修复常见配置问题
        export ARCH=arm64
       
        # 1. 确保使用正确的交叉编译器
        echo "设置编译器..."
        if [ -d "/opt/aarch64-linux-android-4.9" ]; then
          export CROSS_COMPILE=/opt/aarch64-linux-android-4.9/bin/aarch64-linux-android-
        else
          export CROSS_COMPILE=aarch64-linux-android-
        fi
       
        # 2. 生成最终配置
        echo "生成最终配置..."
        make olddefconfig
       
        # 3. 检查并修复可能的问题
        echo "检查配置..."
       
        # 确保这些基本选项启用
        for opt in MODULES KPROBES OVERLAY_FS; do
          if ! grep -q "^CONFIG_${opt}=y" .config; then
            echo "修复 CONFIG_${opt}..."
            sed -i "/CONFIG_${opt}/d" .config
            echo "CONFIG_${opt}=y" >> .config
          fi
        done
       
    - name: Build step by step
      run: |
        cd kernel
       
        export ARCH=arm64
        if [ -d "/opt/aarch64-linux-android-4.9" ]; then
          export CROSS_COMPILE=/opt/aarch64-linux-android-4.9/bin/aarch64-linux-android-
          export PATH="/opt/aarch64-linux-android-4.9/bin:$PATH"
        fi
       
        echo "=== 逐步编译 ==="
       
        # 1. 先准备（通常会暴露问题）
        echo "步骤1: make prepare..."
        make prepare -j$(nproc) || {
          echo "prepare失败，查看错误..."
          exit 1
        }
       
        # 2. 编译vmlinux（内核主体）
        echo "步骤2: make vmlinux..."
        make vmlinux -j$(nproc) || {
          echo "vmlinux编译失败"
          # 继续尝试其他目标
        }
       
        # 3. 编译模块
        echo "步骤3: make modules..."
        make modules -j$(nproc) || {
          echo "模块编译失败"
        }
       
        # 4. 编译最终镜像
        echo "步骤4: make Image.gz..."
        make Image.gz -j$(nproc) || {
          echo "Image.gz编译失败"
        }
       
    - name: Check build results
      run: |
        cd kernel
       
        echo "=== 编译结果检查 ==="
       
        if [ -f "arch/arm64/boot/Image.gz" ]; then
          echo "✅ 成功生成 Image.gz"
          ls -lh arch/arm64/boot/Image.gz
        else
          echo "❌ 未生成 Image.gz"
          echo "尝试的文件："
          find arch/arm64/boot/ -type f 2>/dev/null || true
        fi
       
        if [ -f "vmlinux" ]; then
          echo "✅ 成功生成 vmlinux"
          ls -lh vmlinux
        fi
       
    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-debug
        path: |
          kernel/.config
          kernel/arch/arm64/boot/
          kernel/vmlinux 2>/dev/null || true
