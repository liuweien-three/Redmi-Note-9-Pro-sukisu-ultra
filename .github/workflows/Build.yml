name: Build KernelSU for gauguin (Complete)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout kernel
      run: |
        git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_gauguin -b lineage-23.0
        
    - name: Setup KernelSU
      run: |
        cd android_kernel_xiaomi_gauguin
        
        echo "=== 设置 KernelSU ==="
        
        # 下载 KernelSU 补丁
        echo "下载 KernelSU 4.19 补丁..."
        wget -q https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/patches/4.19.patch -O ksu.patch || true
        
        if [ -f "ksu.patch" ] && [ -s "ksu.patch" ]; then
            echo "应用 KernelSU 补丁..."
            patch -p1 < ksu.patch || echo "补丁应用可能有问题，继续..."
        else
            echo "未找到有效的补丁文件，跳过补丁应用"
        fi

        echo "配置 KernelSU..."
        echo -e "\n# KernelSU\nCONFIG_KSU=y\nCONFIG_KSU_DEBUG=n" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        
        echo "当前配置尾部:"
        tail -5 arch/arm64/configs/vendor/xiaomi/gauguin.config
        
    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          gcc-aarch64-linux-gnu \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev
        
    - name: Build
      run: |
        cd android_kernel_xiaomi_gauguin

        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # 配置
        echo "运行 defconfig..."
        make vendor/xiaomi/gauguin.config

        echo "开始编译..."
        make -j$(nproc) Image dtbs 2>&1 | tee build.log

        echo "检查输出:"
        if [ -f "arch/arm64/boot/Image" ]; then
            echo "✅ 成功生成内核"
            ls -lh arch/arm64/boot/
        else
            echo "❌ 编译失败"
            exit 1
        fi
        
    - name: Collect output files
      if: success()
      run: |
        cd android_kernel_xiaomi_gauguin

        mkdir -p kernel_output

        if [ -f "arch/arm64/boot/Image" ]; then
            cp arch/arm64/boot/Image kernel_output/
        fi
        
        if [ -f "arch/arm64/boot/Image.gz" ]; then
            cp arch/arm64/boot/Image.gz kernel_output/
        fi

        if [ -d "arch/arm64/boot/dts" ]; then
            find arch/arm64/boot/dts -name "*.dtb" -type f 2>/dev/null | xargs -I {} cp {} kernel_output/ 2>/dev/null || true
        fi

        if [ -f ".config" ]; then
            cp .config kernel_output/config
        fi
        
        if [ -f "build.log" ]; then
            cp build.log kernel_output/
        fi
        
        echo "生成的文件:"
        ls -la kernel_output/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-files
        path: android_kernel_xiaomi_gauguin/kernel_output/
        
    - name: Show build summary
      if: always()
      run: |
        echo "=== 构建总结 ==="
        cd android_kernel_xiaomi_gauguin 2>/dev/null || exit 0
        
        if [ -f "arch/arm64/boot/Image" ]; then
            echo "状态: ✅ 成功"
            echo "内核文件: arch/arm64/boot/Image"
            echo "大小: $(stat -c%s arch/arm64/boot/Image 2>/dev/null || echo 未知) bytes"
        else
            echo "状态: ❌ 失败"
            if [ -f "build.log" ]; then
                echo "最后错误:"
                tail -20 build.log
            fi
        fi
