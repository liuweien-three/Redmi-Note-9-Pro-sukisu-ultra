name: Build Kernel for gauguinpr

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
   
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
     
    - name: Download Official Linux Kernel
      run: |
        echo "ğŸ“¥ Downloading official Linux kernel..."
        wget -q --timeout=30 https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.325.tar.xz
        tar -xf linux-4.19.325.tar.xz
        mv linux-4.19.325 kernel-source
        echo "âœ… Kernel source ready"
       
    - name: Create SukiSU Implementation
      run: |
        echo "ğŸ”§ Creating SukiSU implementation..."
        cd kernel-source
       
        mkdir -p drivers/misc/sukisu

        echo "#include <linux/init.h>" > drivers/misc/sukisu/sukisu_core.c
        echo "#include <linux/module.h>" >> drivers/misc/sukisu/sukisu_core.c
        echo "#include <linux/kernel.h>" >> drivers/misc/sukisu/sukisu_core.c
        echo "" >> drivers/misc/sukisu/sukisu_core.c
        echo "static int __init sukisu_init(void)" >> drivers/misc/sukisu/sukisu_core.c
        echo "{" >> drivers/misc/sukisu/sukisu_core.c
        echo "    printk(KERN_INFO \"SukiSU: Loaded successfully\\n\");" >> drivers/misc/sukisu/sukisu_core.c
        echo "    return 0;" >> drivers/misc/sukisu/sukisu_core.c
        echo "}" >> drivers/misc/sukisu/sukisu_core.c
        echo "" >> drivers/misc/sukisu/sukisu_core.c
        echo "static void __exit sukisu_exit(void)" >> drivers/misc/sukisu/sukisu_core.c
        echo "{" >> drivers/misc/sukisu/sukisu_core.c
        echo "    printk(KERN_INFO \"SukiSU: Unloaded\\n\");" >> drivers/misc/sukisu/sukisu_core.c
        echo "}" >> drivers/misc/sukisu/sukisu_core.c
        echo "" >> drivers/misc/sukisu/sukisu_core.c
        echo "module_init(sukisu_init);" >> drivers/misc/sukisu/sukisu_core.c
        echo "module_exit(sukisu_exit);" >> drivers/misc/sukisu/sukisu_core.c
        echo "MODULE_LICENSE(\"GPL\");" >> drivers/misc/sukisu/sukisu_core.c
        echo "MODULE_DESCRIPTION(\"SukiSU Implementation\");" >> drivers/misc/sukisu/sukisu_core.c
       
        echo "obj-y += sukisu_core.o" > drivers/misc/sukisu/Makefile
       
        echo "config SUKISU" > drivers/misc/sukisu/Kconfig
        echo "    bool \"SukiSU Support\"" >> drivers/misc/sukisu/Kconfig
        echo "    default y" >> drivers/misc/sukisu/Kconfig
       
        echo "âœ… SukiSU created"
       
    - name: Install Dependencies
      run: |
        echo "ğŸ”§ Installing dependencies..."
        sudo apt-get update
        sudo apt-get install -y build-essential clang gcc-aarch64-linux-gnu libssl-dev libelf-dev bc
       
    - name: Build Kernel
      run: |
        echo "ğŸ—ï¸ Building kernel..."
        cd kernel-source
       
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
       
        make defconfig
       
        echo 'obj-y += sukisu/' >> drivers/misc/Makefile
        echo 'source "drivers/misc/sukisu/Kconfig"' >> drivers/misc/Kconfig
       
        make olddefconfig
        make -j$(nproc)
       
        echo "âœ… Build completed"
       
    - name: Check Build Result
      run: |
        cd kernel-source
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "ğŸ‰ SUCCESS: Kernel built!"
          ls -lh arch/arm64/boot/Image
        else
          echo "âŒ Build failed"
          exit 1
        fi
       
    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: kernel-image
        path: kernel-source/arch/arm64/boot/Image
