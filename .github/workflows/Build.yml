name: Build KernelSU for gauguin (Complete)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout kernel source
      run: |
        git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_gauguin -b lineage-23.0
        
    - name: Apply KernelSU patch
      run: |
        cd android_kernel_xiaomi_gauguin

        echo "下载 KernelSU 4.19 补丁..."
        wget -q https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/patches/4.19.patch -O ksu.patch || echo "补丁下载失败，继续..."
        
        if [ -f "ksu.patch" ]; then
            echo "应用 KernelSU 补丁..."
            patch -p1 < ksu.patch || echo "补丁可能有冲突，继续..."
        fi
 
        echo "添加 KernelSU 配置..."
        echo "" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        echo "# KernelSU" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        echo "CONFIG_KSU=y" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        echo "CONFIG_KSU_DEBUG=n" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          gcc-aarch64-linux-gnu \
          ccache
        
    - name: Build kernel
      run: |
        cd android_kernel_xiaomi_gauguin

        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KBUILD_BUILD_USER=github
        export KBUILD_BUILD_HOST=actions

        echo "配置内核..."
        make vendor/xiaomi/gauguin.config

        echo "开始编译内核..."
        make -j$(nproc) Image dtbs 2>&1 | tee build.log

        echo "编译完成，检查输出文件："
        ls -la arch/arm64/boot/ || echo "没有找到输出目录"
        
        if [ -f "arch/arm64/boot/Image" ]; then
            echo "✅ 内核编译成功！"
            echo "文件大小: $(stat -c%s arch/arm64/boot/Image) bytes"
        else
            echo "❌ 编译失败"
            echo "最后 50 行日志："
            tail -50 build.log
            exit 1
        fi
        
    - name: Create artifacts directory
      if: success()
      run: |
        cd android_kernel_xiaomi_gauguin
        mkdir -p artifacts

        if [ -f "arch/arm64/boot/Image" ]; then
            cp arch/arm64/boot/Image artifacts/
        fi

        if [ -d "arch/arm64/boot/dts" ]; then
            find arch/arm64/boot/dts -name "*.dtb" | head -10 | xargs -I {} cp {} artifacts/ 2>/dev/null || true
        fi

        if [ -f ".config" ]; then
            cp .config artifacts/kernel.config
        fi

        if [ -f "build.log" ]; then
            cp build.log artifacts/
        fi
        
        echo "打包的文件："
        ls -la artifacts/
        
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: kernel-build-output
        path: android_kernel_xiaomi_gauguin/artifacts/
        
    - name: Debug on failure
      if: failure()
      run: |
        echo "编译失败，调试信息："
        cd android_kernel_xiaomi_gauguin 2>/dev/null || exit 0
        
        echo "内核版本："
        head -5 Makefile 2>/dev/null || echo "无法读取 Makefile"
        
        echo "配置文件："
        ls -la arch/arm64/configs/vendor/xiaomi/ 2>/dev/null || echo "无法访问配置目录"
        
        echo "最后 100 行编译日志："
        tail -100 build.log 2>/dev/null || echo "没有编译日志"
