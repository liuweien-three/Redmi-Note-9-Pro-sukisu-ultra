name: Build Gauguin Kernel (64-bit only)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
   
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
     
    - name: Download config file
      run: |
        curl -L -o device.config "https://gamerminecraft.lanzouu.com/il3z23eyhihe"
        echo "配置下载完成"
       
    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch lineage-23.0 \
          https://github.com/LineageOS/android_kernel_xiaomi_gauguin \
          kernel
         
    - name: Install 64-bit build tools only
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          libncurses5-dev \
          bc \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          gcc-aarch64-linux-gnu \
          clang \
          llvm \
          lld
       
        echo "工具安装完成"
        echo "编译器版本:"
        aarch64-linux-gnu-gcc --version | head -1
        clang --version | head -1
       
    - name: Prepare kernel configuration
      run: |
        cd kernel
       
        # 使用设备配置
        cp ../device.config .config
       
        # 清理配置
        echo "清理配置..."
        sed -i '/^#/d' .config  # 删除所有注释行
        sed -i '/^$/d' .config  # 删除空行
       
        # 启用KernelSU必需选项（最少选项）
        echo "" >> .config
        echo "# KernelSU minimal config" >> .config
        echo "CONFIG_KPROBES=y" >> .config
        echo "CONFIG_MODULES=y" >> .config
        echo "CONFIG_OVERLAY_FS=y" >> .config
        echo "CONFIG_KALLSYMS=y" >> .config
       
        # 去重
        awk '!seen[$1]++' .config > .config.tmp
        mv .config.tmp .config
       
        echo "配置行数: $(wc -l < .config)"
       
    - name: Try build with GCC
      id: build_gcc
      continue-on-error: true
      run: |
        cd kernel
       
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
       
        echo "=== 使用GCC编译 ==="
        echo "编译器: $(which ${CROSS_COMPILE}gcc)"
       
        # 生成配置
        make olddefconfig
       
        # 尝试编译
        make -j$(nproc) Image.gz 2>&1 | tee build.log
       
        if [ -f "arch/arm64/boot/Image.gz" ]; then
          echo "✅ GCC编译成功"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "❌ GCC编译失败"
          echo "success=false" >> $GITHUB_OUTPUT
        fi
       
    - name: Try build with Clang (if GCC fails)
      if: steps.build_gcc.outputs.success != 'true'
      id: build_clang
      continue-on-error: true
      run: |
        cd kernel
       
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=clang
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
       
        echo "=== 使用Clang编译 ==="
        echo "Clang版本: $(clang --version | head -1)"
       
        # 清理之前的构建
        make mrproper
        cp ../device.config .config
       
        # 添加Clang兼容选项
        echo "" >> .config
        echo "# Clang compatibility" >> .config
        echo "CONFIG_KPROBES=y" >> .config
        echo "CONFIG_MODULES=y" >> .config
        echo "CONFIG_CC_IS_CLANG=y" >> .config
        echo "CONFIG_LD_IS_LLD=y" >> .config
       
        make olddefconfig
       
        # 使用Clang编译
        make CC=clang LD=ld.lld -j$(nproc) Image.gz 2>&1 | tee build_clang.log
       
        if [ -f "arch/arm64/boot/Image.gz" ]; then
          echo "✅ Clang编译成功"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "❌ Clang编译失败"
          echo "success=false" >> $GITHUB_OUTPUT
        fi
       
    - name: Build with simplified config (last resort)
      if: steps.build_gcc.outputs.success != 'true' && steps.build_clang.outputs.success != 'true'
      run: |
        cd kernel
       
        echo "=== 使用最简配置编译 ==="
       
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
       
        # 完全清理
        make mrproper
       
        # 使用defconfig（最基础的配置）
        make defconfig
       
        # 只启用最必要的选项
        echo "" >> .config
        echo "CONFIG_MODULES=y" >> .config
        echo "CONFIG_KPROBES=y" >> .config
       
        make olddefconfig
       
        echo "开始编译..."
        make -j$(nproc) Image.gz
       
    - name: Check build results
      run: |
        echo "=== 检查构建结果 ==="
       
        mkdir -p output
       
        if [ -f "kernel/arch/arm64/boot/Image.gz" ]; then
          cp kernel/arch/arm64/boot/Image.gz output/
          cp kernel/.config output/kernel.config
          echo "✅ 编译成功！"
          ls -lh output/
        else
          echo "❌ 编译失败"
          echo "查看错误日志："
          tail -50 kernel/build*.log 2>/dev/null || echo "无日志"
        fi
       
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-result
        path: |
          output/
          kernel/build*.log 2>/dev/null || true
