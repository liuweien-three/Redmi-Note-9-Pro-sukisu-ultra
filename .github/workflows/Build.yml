name: Build KernelSU for gauguin

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout kernel source
      run: |
        git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_gauguin -b lineage-23.0
        
    - name: Apply KernelSU
      run: |
        cd android_kernel_xiaomi_gauguin
        
        echo "=== 设置 KernelSU ==="

        echo "下载 KernelSU 补丁..."
        wget -q https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/patches/4.19.patch -O ksu.patch || true
        
        if [ -f "ksu.patch" ] && [ -s "ksu.patch" ]; then
            echo "应用 KernelSU 补丁..."
            patch -p1 < ksu.patch 2>&1 | grep -v "ignored" || echo "补丁可能有冲突，继续..."
        fi

        echo "添加 KernelSU 配置..."
        echo -e "\n# KernelSU\nCONFIG_KSU=y\nCONFIG_KSU_DEBUG=n" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          lz4 \
          lzop \
          gcc-aarch64-linux-gnu \
          gcc-11-aarch64-linux-gnu \
          python3 \
          make
      
    - name: Build kernel 
      run: |
        cd android_kernel_xiaomi_gauguin
        
        echo "=== 开始完整编译 ==="

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make clean 2>/dev/null || true
        make mrproper 2>/dev/null || true

        echo "1. 配置内核..."

        make vendor/xiaomi/gauguin.defconfig 2>&1 | tee config1.log || \
        make vendor/xiaomi/gauguin.config 2>&1 | tee config1.log || \
        make gauguin_defconfig 2>&1 | tee config1.log
        
        echo "2. 显示当前配置..."
        grep -i "KSU\|kernelsu" .config || echo "KSU 配置未启用"

        echo "3. 编译完整内核..."
        time make -j$(nproc) 2>&1 | tee build_full.log
        
        echo "4. 检查生成的文件..."

        echo "在 arch/arm64/boot/ 中的文件:"
        ls -la arch/arm64/boot/ 2>/dev/null || echo "boot 目录不存在"
        
        echo "在根目录中的文件:"
        ls -la vmlinux vmlinux.* 2>/dev/null || echo "vmlinux 不存在"

        if [ -f "vmlinux" ]; then
            echo "5. 从 vmlinux 生成 Image..."
            aarch64-linux-gnu-objcopy -O binary -R .note -R .comment -S vmlinux arch/arm64/boot/Image
        fi

        if [ -f "arch/arm64/boot/Image" ]; then
            echo "✅ 编译成功！"
            echo "Image 大小: $(stat -c%s arch/arm64/boot/Image) 字节"
        else
            echo "❌ 编译可能失败"
            echo "查看错误日志:"
            tail -100 build_full.log | grep -i "error\|fatal\|stop" || tail -50 build_full.log
        fi
        
    - name: Debug build
      if: failure()
      run: |
        cd android_kernel_xiaomi_gauguin
        
        echo "=== 调试信息 ==="

        echo "1. 内核版本:"
        head -5 Makefile

        echo "2. 工具链:"
        which aarch64-linux-gnu-gcc
        aarch64-linux-gnu-gcc --version | head -1

        echo "3. 配置文件:"
        ls -la .config arch/arm64/configs/vendor/xiaomi/gauguin.config 2>/dev/null || echo "无配置文件"

        echo "4. 编译错误:"
        if [ -f "build_full.log" ]; then
            grep -n "error:" build_full.log | head -20
            echo "..."
            tail -100 build_full.log
        fi
        
    - name: Collect output
      if: success()
      run: |
        cd android_kernel_xiaomi_gauguin
        
        mkdir -p output

        find arch/arm64/boot/ -type f -name "Image*" -o -name "*zImage*" 2>/dev/null | xargs -I {} cp {} output/ 2>/dev/null || true
        
        if [ -f "vmlinux" ]; then
            cp vmlinux output/
        fi
        
        if [ -f ".config" ]; then
            cp .config output/
        fi
        
        echo "生成的文件:"
        ls -la output/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: android_kernel_xiaomi_gauguin/output/
