name: Build Gauguin Kernel with SukiSU

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
 
    steps:
    - name: Checkout LineageOS kernel
      uses: actions/checkout@v4
      with:
        repository: LineageOS/android_kernel_xiaomi_gauguin
        ref: lineage-23
        path: kernel-src
       
    - name: Checkout SukiSU source
      uses: actions/checkout@v4
      with:
        repository: SukiSU-Ultra/SukiSU-Ultra
        path: sukisu
     
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential libncurses-dev bison flex libssl-dev libelf-dev bc python3 git gcc-aarch64-linux-gnu patch
     
    - name: Integrate SukiSU modifications
      run: |
        cd kernel-src
       
        echo "开始集成 SukiSU 修改..."

        echo "复制 SukiSU 源码文件..."
        cp -r ../sukisu/* . 2>/dev/null || echo "部分文件复制失败（正常）"

        if find ../sukisu -name "*.patch" | head -1; then
          echo "应用 SukiSU 补丁..."
          for patch in ../sukisu/*.patch; do
            patch -p1 < "$patch" || echo "补丁应用失败: $patch"
          done
        fi

        if [ -f "../sukisu/.config" ]; then
          echo "合并 SukiSU 配置..."
          cp ../sukisu/.config .config
        fi
       
        echo "集成完成"
     
    - name: Build kernel
      run: |
        cd kernel-src
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        make lineageos_gauguin_defconfig || make defconfig
       
        echo "开始编译内核和设备树..."
        make -j$(nproc) all dtbs 2>&1 | tee build.log
       
        echo "编译完成，检查产物..."
        ls -la arch/arm64/boot/
        find arch/arm64/boot/dts -name "*.dtb" -type f | head -5
     
    - name: Check build results
      run: |
        cd kernel-src
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "✅ 内核编译成功！"
          echo "文件大小:"
          ls -lh arch/arm64/boot/Image
          echo "设备树文件:"
          find arch/arm64/boot/dts -name "*.dtb" -type f | head -5
        else
          echo "❌ 内核编译失败"
          tail -100 build.log
          exit 1
        fi
     
    - name: Create flashable package
      run: |

        mkdir flashable
        cd flashable
        cp ../kernel-src/arch/arm64/boot/Image ./
      
        zip -r SukiSU-Gauguin
     
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sukisu-gauguin-kernel
        path: |
          kernel-src/arch/arm64/boot/Image
          kernel-src/arch/arm64/boot/dts/**/*.dtb
          flashable/SukiSU-Gauguin-Kernel.zip
          kernel-src/build.log
        retention-days: 7
