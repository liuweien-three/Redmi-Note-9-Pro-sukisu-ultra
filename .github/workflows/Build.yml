name: Build SukiSU Kernel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
 
    steps:
    - name: Checkout SukiSU source
      uses: actions/checkout@v4
      with:
        repository: SukiSU-Ultra/SukiSU-Ultra
        path: sukisu
     
    - name: Download kernel source via mirror
      run: |
        wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v4.x/linux-4.19.325.tar.xz
        tar -xf linux-4.19.325.tar.xz
        mv linux-4.19.325 kernel-src
     
    - name: Install dependencies
      run: |
        sudo sed -i 's/archive.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
        sudo sed -i 's/security.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
        sudo apt update
        sudo apt install -y build-essential libncurses-dev bison flex libssl-dev libelf-dev bc python3 git gcc-aarch64-linux-gnu
     
    - name: Setup build environment
      run: |
        cd kernel-src
        cp ../sukisu/arch/arm64/configs/gauguin_defconfig arch/arm64/configs/ || echo "使用默认配置"
     
    - name: Build kernel
      run: |
        cd kernel-src
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        make gauguin_defconfig || make defconfig
        echo "开始编译内核和设备树..."

        make -j$(nproc) all dtbs 2>&1 | tee build.log
       
        echo "编译完成，检查产物..."
        ls -la arch/arm64/boot/
        find arch/arm64/boot/dts -name "*.dtb" -type f | head -5 || echo "未找到.dtb文件"
     
    - name: Check build results
      run: |
        cd kernel-src
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "✅ 内核编译成功！"
          echo "生成的文件："
          ls -lh arch/arm64/boot/Image
          echo "=== 设备树文件 ==="
          find arch/arm64/boot/dts -name "*.dtb" -type f | head -5
        else
          echo "❌ 内核编译失败"
          tail -100 build.log
          exit 1
        fi
     
    - name: Upload kernel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sukisu-kernel-build
        path: |
          kernel-src/arch/arm64/boot/Image
          kernel-src/arch/arm64/boot/dts/**/*.dtb
          kernel-src/.config
          kernel-src/build.log
        retention-days: 7
