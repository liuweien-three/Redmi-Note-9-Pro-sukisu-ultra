name: Build Gauguin Kernel with KernelSU

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: '内核分支'
        default: 'lineage-23.0'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
   
    steps:
    # 第1步：检出仓库
    - name: Checkout repository
      uses: actions/checkout@v4
     
    # 第2步：下载配置文件并确保位置正确
    - name: Download and prepare config
      run: |
        echo "=== 下载配置文件 ==="
       
        # 下载到工作空间根目录
        curl -L -o /tmp/config.txt "https://gamerminecraft.lanzouu.com/il3z23eyhihe"
       
        # 检查文件
        if [ ! -f "/tmp/config.txt" ]; then
          echo "❌ 下载失败"
          exit 1
        fi
       
        # 复制到工作空间
        cp /tmp/config.txt "$GITHUB_WORKSPACE/device.config"
       
        echo "✅ 配置文件已保存到：$GITHUB_WORKSPACE/device.config"
        echo "文件大小：$(wc -l < "$GITHUB_WORKSPACE/device.config") 行"
       
    # 第3步：克隆内核源码
    - name: Clone kernel source
      run: |
        echo "克隆内核源码..."
        git clone --depth=1 \
          --branch "${{ github.event.inputs.kernel_branch }}" \
          https://github.com/LineageOS/android_kernel_xiaomi_gauguin \
          "$GITHUB_WORKSPACE/kernel"
         
        cd "$GITHUB_WORKSPACE/kernel"
        echo "内核位置：$(pwd)"
       
    # 第4步：安装工具
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libncurses5-dev bc bison flex \
          libssl-dev libelf-dev gcc-aarch64-linux-gnu
       
    # 第5步：创建配置（使用绝对路径）
    - name: Create kernel configuration
      run: |
        cd "$GITHUB_WORKSPACE/kernel"
       
        echo "=== 创建内核配置 ==="
       
        # 使用绝对路径确保找到文件
        CONFIG_FILE="$GITHUB_WORKSPACE/device.config"
       
        if [ -f "$CONFIG_FILE" ]; then
          echo "使用 device.config"
          cp "$CONFIG_FILE" .config
          echo "✅ 配置已复制"
        else
          echo "❌ 找不到配置文件：$CONFIG_FILE"
          echo "当前目录内容："
          ls -la "$GITHUB_WORKSPACE/"
          exit 1
        fi
       
        # 启用KernelSU选项（简化版，避免EOF问题）
        echo "" >> .config
        echo "# KernelSU Configurations" >> .config
        echo "CONFIG_KPROBES=y" >> .config
        echo "CONFIG_MODULES=y" >> .config
        echo "CONFIG_OVERLAY_FS=y" >> .config
        echo "CONFIG_KALLSYMS=y" >> .config
       
        echo "配置行数：$(wc -l < .config)"
       
    # 第6步：验证配置
    - name: Verify configuration
      run: |
        cd "$GITHUB_WORKSPACE/kernel"
       
        export ARCH=arm64
       
        echo "生成最终配置..."
        make olddefconfig
       
        echo "关键配置检查："
        grep -E "KPROBES|MODULES|OVERLAY" .config || true
       
    # 第7步：编译
    - name: Build kernel
      run: |
        cd "$GITHUB_WORKSPACE/kernel"
       
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
       
        echo "开始编译..."
        make -j$(nproc) Image.gz
       
        echo "编译完成！"
        ls -lh arch/arm64/boot/
       
    # 第8步：打包结果
    - name: Package results
      run: |
        mkdir -p "$GITHUB_WORKSPACE/output"
       
        # 复制内核镜像
        if [ -f "$GITHUB_WORKSPACE/kernel/arch/arm64/boot/Image.gz" ]; then
          cp "$GITHUB_WORKSPACE/kernel/arch/arm64/boot/Image.gz" "$GITHUB_WORKSPACE/output/"
          echo "✅ 内核镜像已保存"
        fi
       
        # 复制配置
        cp "$GITHUB_WORKSPACE/kernel/.config" "$GITHUB_WORKSPACE/output/kernel.config"
        cp "$GITHUB_WORKSPACE/device.config" "$GITHUB_WORKSPACE/output/device.config"
       
        echo "输出文件："
        ls -la "$GITHUB_WORKSPACE/output/"
       
    # 第9步：上传
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: "$GITHUB_WORKSPACE/output/"
