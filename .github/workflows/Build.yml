name: Build KernelSU for gauguin

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout kernel source
      run: |
        git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_gauguin -b lineage-23.0
        
    - name: Apply KernelSU 
      run: |
        cd android_kernel_xiaomi_gauguin
        
        echo "=== 设置 KernelSU ==="

        echo "添加 KernelSU 配置..."
        echo -e "\n# KernelSU\nCONFIG_KSU=y\nCONFIG_KSU_DEBUG=n" >> arch/arm64/configs/vendor/xiaomi/gauguin.config

        echo "CONFIG_COMPAT=y" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        echo "CONFIG_OVERLAY_FS=y" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          lz4 \
          lzop \
          gcc-aarch64-linux-gnu \
          python3 \
          python
        
    - name: Build kernel 
      run: |
        cd android_kernel_xiaomi_gauguin
        
        echo "=== 开始编译 ==="

        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        echo "1. 清理..."
        make clean 2>/dev/null || true

        echo "2. 配置内核..."
        make vendor/xiaomi/gauguin.config

        echo "3. 检查配置状态:"
        grep -E "KSU|COMPAT|OVERLAY" .config || echo "相关配置未找到"

        echo "4. 编译内核..."
        make -j$(nproc) 2>&1 | tee build.log

        if [ -f "arch/arm64/boot/Image" ]; then
            echo "✅ 编译成功!"
            echo "Image 大小: $(stat -c%s arch/arm64/boot/Image) 字节"
        else
            echo "❌ 编译失败"
            echo "错误摘要:"
            grep -n "error:" build.log | head -20
            exit 1
        fi
        
    - name: Collect artifacts
      if: success()
      run: |
        cd android_kernel_xiaomi_gauguin
        
        mkdir -p output
        
        if [ -f "arch/arm64/boot/Image" ]; then
            cp arch/arm64/boot/Image output/
        fi
        
        if [ -f ".config" ]; then
            cp .config output/
        fi
        
        if [ -f "build.log" ]; then
            cp build.log output/
        fi
        
        echo "生成的文件:"
        ls -la output/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: android_kernel_xiaomi_gauguin/output/
