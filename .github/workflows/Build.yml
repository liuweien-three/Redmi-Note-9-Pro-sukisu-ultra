name: Build KernelSU for gauguin

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥è‡ªåŠ¨æ„å»º

env:
  KERNEL_VERSION: "lineage-23.0"
  DEVICE: "gauguin"
  ARCH: "arm64"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout SukiSU Ultra source
      uses: actions/checkout@v4
      with:
        repository: SukiSU-Ultra/SukiSU-Ultra
        path: sukisu
        ref: main
        
    - name: Checkout LineageOS kernel source
      uses: actions/checkout@v4
      with:
        repository: LineageOS/android_kernel_xiaomi_gauguin
        ref: ${{ env.KERNEL_VERSION }}
        path: kernel-source
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          libncurses-dev \
          bison flex \
          libssl-dev libelf-dev \
          bc python3 \
          git wget curl \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          ccache
          
        echo "CCACHE_DIR=/tmp/ccache" >> $GITHUB_ENV
        ccache -M 5G
        ccache -s
        
    - name: Integrate KernelSU from SukiSU
      run: |
        echo "=== é›†æˆKernelSU ==="

        cp -r sukisu/kernel/kpm kernel-source/kernel/
        cp sukisu/kernel/*.c sukisu/kernel/*.h kernel-source/kernel/ 2>/dev/null || true

        cd kernel-source/kernel
        echo -e "\n# KernelSU\nobj-\$(CONFIG_KSU) += kpm/" >> Makefile

        for file in *.c; do
          if grep -q "KSU\|kernelsu" "$file" 2>/dev/null; then
            base=$(basename "$file" .c)
            if [[ "$base" != "main" ]]; then
              echo "obj-\$(CONFIG_KSU) += $base.o" >> Makefile
            fi
          fi
        done

        cd ..
        CONFIG_FILE="arch/arm64/configs/vendor/xiaomi/gauguin.config"
        if [ -f "$CONFIG_FILE" ]; then
          echo -e "\n# KernelSU\nCONFIG_KSU=y\nCONFIG_KPROBES=y\nCONFIG_MODULES=y" >> "$CONFIG_FILE"
        fi
        
        echo "âœ… KernelSUé›†æˆå®Œæˆ"
        
    - name: Build kernel
      run: |
        cd kernel-source
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=clang

        make vendor/xiaomi/gauguin.config

        echo "=== å…³é”®é…ç½®æ£€æŸ¥ ==="
        grep -E "CONFIG_(KSU|KPROBES|MODULES)" .config || echo "é…ç½®æœªæ‰¾åˆ°"

        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        make -j$(nproc) Image dtbs 2>&1 | tee build.log
        
    - name: Check build artifacts
      run: |
        cd kernel-source
        
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "å†…æ ¸å¤§å°: $(wc -c < arch/arm64/boot/Image | awk '{print $1/1024/1024 " MB"}')"

          if find kernel/kpm -name "*.ko" | grep -q .; then
            echo "âœ… KernelSUæ¨¡å—ç¼–è¯‘æˆåŠŸ"
          fi
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "æœ€å100è¡Œæ—¥å¿—:"
          tail -100 build.log
          exit 1
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gauguin-kernelsu-${{ github.run_id }}
        path: |
          kernel-source/arch/arm64/boot/Image
          kernel-source/arch/arm64/boot/dts/**/*.dtb
          kernel-source/.config
          kernel-source/build.log
        retention-days: 90
        
    - name: Create release (optional)
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: |
          kernel-source/arch/arm64/boot/Image
        tag_name: gauguin-kernelsu-${{ github.run_number }}
        name: "KernelSU for gauguin (LineageOS ${{ env.KERNEL_VERSION }})"
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºçš„KernelSUå†…æ ¸
          
          **è®¾å¤‡:** xiaomi gauguin (Redmi Note 9 Pro)
          **å†…æ ¸ç‰ˆæœ¬:** LineageOS ${{ env.KERNEL_VERSION }}
          **é›†æˆ:** KernelSU from SukiSU Ultra
          **æ„å»ºæ—¶é—´:** ${{ github.event.head_commit.timestamp }}
          
          ä½¿ç”¨æ–¹æ³•ï¼š
          1. ä¸‹è½½ Image æ–‡ä»¶
          2. æ‰“åŒ…åˆ° boot.img
          3. åˆ·å…¥è®¾å¤‡
