name: Build SukiSU Ultra Kernel for Gauguinpro

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  KERNEL_NAME: SukiSU-Ultra-gauguinpro
  KERNEL_DIR: kernel
  ANY_KERNEL_DIR: AnyKernel3
  CONFIG: vendor/gauguin_defconfig

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:

    - name: Checkout Gauguinpro Kernel Source
      run: |
        git clone -b lineage-23.0 https://github.com/LineageOS/android_kernel_xiaomi_gauguin.git ${{ env.KERNEL_DIR }} ||

        (echo "‚ùå Kernel source clone failed" && exit 1)

    - name: Manually Integrate SukiSU
      run: |
        cd ${{ env.KERNEL_DIR }}
        
        echo "üîß Manually integrating SukiSU..."

        mkdir -p drivers/sukisu

        echo "üì• Downloading SukiSU source files..."
        wget -q -O drivers/sukisu/Kconfig https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/Kconfig
        wget -q -O drivers/sukisu/Makefile https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/Makefile
        wget -q -O drivers/sukisu/sukisu.c https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/sukisu.c
        wget -q -O drivers/sukisu/sukisu.h https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/sukisu.h
        wget -q -O drivers/sukisu/sulog.c https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/sulog.c
        wget -q -O drivers/sukisu/sulog.h https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/sulog.h

        if ! grep -q "sukisu" drivers/Kconfig; then
          echo 'source "drivers/sukisu/Kconfig"' >> drivers/Kconfig
          echo "‚úÖ Added SukiSU to drivers/Kconfig"
        fi

        if ! grep -q "sukisu" drivers/Makefile; then
          echo 'obj-$(CONFIG_SUKISU) += sukisu/' >> drivers/Makefile
          echo "‚úÖ Added SukiSU to drivers/Makefile"
        fi

        echo "üìã Verification:"
        ls -la drivers/sukisu/ && echo "‚úÖ SukiSU directory created"
        grep -n "sukisu" drivers/Kconfig && echo "‚úÖ Kconfig modified"
        grep -n "sukisu" drivers/Makefile && echo "‚úÖ Makefile modified"

    - name: Get AnyKernel3
      uses: actions/checkout@v4
      with:
        repository: osm0sis/AnyKernel3
        path: ${{ env.ANY_KERNEL_DIR }}

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          git \
          zip \
          unzip \
          wget

        wget -qO- https://developer.arm.com/-/media/Files/downloads/gnu-a/10.3-2021.07/binrel/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu.tar.xz | tar -xJ
        echo "GCC_PATH=$(pwd)/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin" >> $GITHUB_ENV

    - name: Setup Environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-none-linux-gnu-" >> $GITHUB_ENV
        echo "PATH=$GCC_PATH:$PATH" >> $GITHUB_ENV

    - name: Build Kernel
      run: |
        cd ${{ env.KERNEL_DIR }}
        
        echo "üßπ Cleaning build directory..."
        make O=out clean && make O=out mrproper
        
        echo "‚öôÔ∏è Applying config: ${{ env.CONFIG }}"
        make O=out ${{ env.CONFIG }}

        echo "üîß Configuring SukiSU..."
        if ! grep -q "CONFIG_SUKISU" out/.config; then
          echo "CONFIG_SUKISU=y" >> out/.config
          echo "‚úÖ Added CONFIG_SUKISU=y to .config"
        else
          sed -i 's/CONFIG_SUKISU=.*/CONFIG_SUKISU=y/' out/.config
          echo "‚úÖ Set CONFIG_SUKISU=y in .config"
        fi

        echo "üìã SukiSU config:"
        grep "SUKISU" out/.config || echo "‚ö†Ô∏è No SUKISU config found"
        
        echo "üöÄ Starting kernel compilation..."
        make O=out -j$(nproc) \
          CROSS_COMPILE=aarch64-none-linux-gnu-

        if [ -f "out/arch/arm64/boot/Image.gz-dtb" ]; then
          echo "‚úÖ Kernel built successfully!"
          ls -lh out/arch/arm64/boot/Image.gz-dtb
          echo "üìä Checking if SukiSU was compiled..."
          find out -name "*sukisu*" -o -name "*sulog*" | head -10
        else
          echo "‚ùå Kernel build failed"
          find out -name "*.o" | head -10
          exit 1
        fi

    - name: Package Kernel
      run: |
        echo "üì¶ Packaging kernel..."
        cp ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz-dtb ${{ env.ANY_KERNEL_DIR }}/
        
        cd ${{ env.ANY_KERNEL_DIR }}
        zip -r9 ../${{ env.KERNEL_NAME }}-$(date +%Y%m%d).zip .

    - name: Upload Kernel Zip
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_NAME }}
        path: ./*.zip
        retention-days: 30
