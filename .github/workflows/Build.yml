name: Build Kernel for gauguin

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
   
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
     
    - name: Download Official Linux Kernel
      run: |
        echo "üì• Downloading official Linux kernel..."
        wget -q https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.325.tar.xz
        tar -xf linux-4.19.325.tar.xz
        mv linux-4.19.325 kernel-source
        echo "‚úÖ Kernel source ready"
       
    - name: Download SukiSU from Proxy
      run: |
       echo "üì• Trying GitHub proxy mirrors..."

       wget -q https://ghproxy.com/https://github.com/ProjectSukisu/SukiSU/archive/refs/heads/main.zip && \
       unzip -q main.zip && \
       mv SukiSU-main sukisu-source && \
       echo "‚úÖ Downloaded from ghproxy" || \
   
       (wget -q https://ghproxy.net/https://github.com/ProjectSukisu/SukiSU/archive/refs/heads/main.zip && \
       unzip -q main.zip && \
       mv SukiSU-main sukisu-source && \
       echo "‚úÖ Downloaded from ghproxy.net") || \
   
       (wget -q https://mirror.ghproxy.com/https://github.com/ProjectSukisu/SukiSU/archive/refs/heads/main.zip && \
       unzip -q main.zip && \
       mv SukiSU-main sukisu-source && \
       echo "‚úÖ Downloaded from mirror.ghproxy") || \
    
       (echo "‚ùå All proxies failed" && exit 1)
       
       - name: Install Dependencies
       run: |
        echo "üîß Installing dependencies..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          libncurses-dev \
          bison flex \
          libssl-dev libelf-dev \
          bc \
          gcc-aarch64-linux-gnu
       
       - name: Build Kernel with SukiSU
       run: |
        echo "üèóÔ∏è Building kernel..."
        cd kernel-source
       
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        make defconfig
        mkdir -p drivers/misc/sukisu
        cp -r ../sukisu-source/kernel/* drivers/misc/sukisu/
        echo 'obj-$(CONFIG_SUKISU) += sukisu/' >> drivers/misc/Makefile
        echo 'source "drivers/misc/sukisu/Kconfig"' >> drivers/misc/Kconfig

        ./scripts/config --set-val CONFIG_SUKISU y
        ./scripts/config --set-val CONFIG_MODULES n
       
        make olddefconfig

        make -j$(nproc)
       
        echo "‚úÖ Build completed"
       
       - name: Check Build Result
       run: |
        cd kernel-source
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "üéâ SUCCESS: Kernel with SukiSU built!"
          ls -lh arch/arm64/boot/Image
        else
          echo "‚ùå Build failed"
          exit 1
        fi
       
       - name: Upload Kernel
       uses: actions/upload-artifact@v4
       with:
        name: kernel-with-sukisu
        path: kernel-source/arch/arm64/boot/Image
