name: Build KernelSU for gauguin

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout kernel source
      run: |
        git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_gauguin -b lineage-23.0
        
    - name: Apply KernelSU
      run: |
        cd android_kernel_xiaomi_gauguin
        
        echo "=== 设置 KernelSU ==="

        echo "下载 KernelSU 补丁..."
        wget -q https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/patches/4.19.patch -O ksu.patch || true
        
        if [ -f "ksu.patch" ] && [ -s "ksu.patch" ]; then
            echo "应用 KernelSU 补丁..."
            patch -p1 < ksu.patch 2>&1 | grep -v "ignored" || echo "补丁可能有冲突，继续..."
        fi

        echo "添加 KernelSU 配置..."
        echo -e "\n# KernelSU\nCONFIG_KSU=y\nCONFIG_KSU_DEBUG=n" >> arch/arm64/configs/vendor/xiaomi/gauguin.config
        
        echo "配置尾部内容:"
        tail -5 arch/arm64/configs/vendor/xiaomi/gauguin.config
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          lz4 \
          lzop \
          gcc-aarch64-linux-gnu \
          python3
        
    - name: Build kernel
      run: |
        cd android_kernel_xiaomi_gauguin
        
        echo "=== 开始编译 ==="

        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        echo "1. 清理..."
        make clean 2>/dev/null || true

        echo "2. 配置内核..."

        echo "尝试: make vendor/xiaomi/gauguin.config"
        make vendor/xiaomi/gauguin.config

        echo "3. 验证 .config 文件..."
        if [ -f ".config" ]; then
            echo ".config 已生成"
            echo "检查 KSU 配置:"
            grep -i "KSU\|kernelsu" .config || echo "KSU 配置未找到"
        else
            echo "错误: .config 未生成"
            exit 1
        fi

        echo "4. 编译内核..."
        make -j$(nproc) 2>&1 | tee build.log
        
        echo "5. 检查输出..."
        if [ -f "arch/arm64/boot/Image" ]; then
            echo "✅ 编译成功!"
            echo "Image 文件: arch/arm64/boot/Image"
            ls -lh arch/arm64/boot/Image
        else
            echo "❌ 编译失败，检查日志..."
            echo "最后错误:"
            tail -30 build.log | grep -i "error\|fatal\|stop" || tail -30 build.log
            echo "完整日志中的错误:"
            grep -n "error:" build.log | head -10
            exit 1
        fi
        
    - name: Collect artifacts
      if: success()
      run: |
        cd android_kernel_xiaomi_gauguin
        
        mkdir -p output

        if [ -f "arch/arm64/boot/Image" ]; then
            cp arch/arm64/boot/Image output/
        fi
        
        if [ -f ".config" ]; then
            cp .config output/
        fi
        
        if [ -f "build.log" ]; then
            cp build.log output/
        fi

        if [ -d "arch/arm64/boot/dts" ]; then
            find arch/arm64/boot/dts -name "*.dtb" -type f 2>/dev/null | head -5 | while read dtb; do
                cp "$dtb" output/
                echo "复制: $(basename "$dtb")"
            done
        fi
        
        echo "生成的文件:"
        ls -la output/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: android_kernel_xiaomi_gauguin/output/
