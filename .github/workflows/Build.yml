name: Build SukiSU Kernel for LineageOS 23

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
 
    steps:
    - name: Checkout LineageOS 23 kernel
      uses: actions/checkout@v4
      with:
        repository: LineageOS/android_kernel_xiaomi_gauguin
        ref: lineage-23.0
        path: kernel-src
       
    - name: Checkout SukiSU source
      uses: actions/checkout@v4
      with:
        repository: SukiSU-Ultra/SukiSU-Ultra
        path: sukisu
     
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential libncurses-dev bison flex libssl-dev libelf-dev bc python3 git gcc-aarch64-linux-gnu
     
    - name: Integrate SukiSU safely
      run: |
        cd kernel-src
       
        echo "安全集成 SukiSU..."

        for dir in kernel drivers fs net; do
          if [ -d "../sukisu/$dir" ]; then
            echo "复制 $dir 目录..."
            cp -r "../sukisu/$dir" "./" 2>/dev/null || echo "$dir 复制完成"
          fi
        done
       
        echo "SukiSU 集成完成"
     
    - name: Build kernel
      run: |
        cd kernel-src
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        make lineageos_gauguin_defconfig
        echo "开始编译 SukiSU 增强内核..."
        make -j$(nproc) all dtbs 2>&1 | tee build.log
     
    - name: Check build results
      run: |
        cd kernel-src
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "✅ SukiSU 内核编译成功！"
          echo "文件大小:"
          ls -lh arch/arm64/boot/Image
          echo "设备树文件:"
          find arch/arm64/boot/dts -name "*.dtb" -type f | head -5
        else
          echo "❌ 内核编译失败"
          tail -100 build.log
          exit 1
        fi
     
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sukisu-lineageos23-kernel
        path: |
          kernel-src/arch/arm64/boot/Image
          kernel-src/arch/arm64/boot/dts/**/*.dtb
          kernel-src/.config
          kernel-src/build.log
        retention-days: 7
