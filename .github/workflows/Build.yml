name: Build SukiSU Ultra Kernel for Gauguinpro

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  KERNEL_NAME: SukiSU-Ultra-gauguinpro
  KERNEL_DIR: kernel
  ANY_KERNEL_DIR: AnyKernel3
  CONFIG: vendor/gauguin_defconfig

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:

    - name: Checkout Gauguinpro Kernel Source
      run: |
        git clone -b lineage-23.0 https://github.com/LineageOS/android_kernel_xiaomi_gauguin.git ${{ env.KERNEL_DIR }} ||

        echo "‚ùå Kernel source clone failed"

    - name: Integrate SukiSU Ultra
      run: |
        cd ${{ env.KERNEL_DIR }}
        
        echo "üîß Integrating SukiSU Ultra..."
        curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -

        echo "üìã Verifying integration..."
        if [ -d "drivers/sukisu" ]; then
          echo "‚úÖ SukiSU Ultra integrated successfully (drivers/sukisu found)"
        elif [ -f "KSU" ]; then
          echo "‚úÖ SukiSU Ultra integrated successfully (KSU file found)" 
        elif grep -q "sukisu" Makefile || grep -q "sukisu" drivers/Kconfig; then
          echo "‚úÖ SukiSU Ultra integrated successfully (Makefile/Kconfig modified)"
        else
          echo "‚ùå SukiSU Ultra integration failed - no traces found"

          echo "üìÅ Current directory contents:"
          ls -la
          echo "üìÅ drivers directory contents:"
          ls -la drivers/ | head -20
          exit 1
        fi

        echo "üîç Checking Kconfig options..."
        if grep -r "SUKISU" . --include="Kconfig*"; then
          echo "‚úÖ SukiSU Kconfig options found"
        fi

    - name: Get AnyKernel3
      uses: actions/checkout@v4
      with:
        repository: osm0sis/AnyKernel3
        path: ${{ env.ANY_KERNEL_DIR }}

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          libssl-dev \
          bc \
          flex \
          bison \
          libelf-dev \
          git \
          zip \
          unzip \
          wget

        wget -qO- https://developer.arm.com/-/media/Files/downloads/gnu-a/10.3-2021.07/binrel/gcc-arm-10.3-2021.

    - name: Setup Environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-none-linux-gnu-" >> $GITHUB_ENV
        echo "PATH=$GCC_PATH:$PATH" >> $GITHUB_ENV

    - name: Build Kernel
      run: |
        cd ${{ env.KERNEL_DIR }}

        make O=out clean && make O=out mrproper

        make O=out ${{ env.CONFIG }}

        if ! grep -q "CONFIG_SUKISU=y" out/.config; then
          echo "CONFIG_SUKISU=y" >> out/.config
          echo "‚úÖ Manually enabled SukiSU in config"
        fi

        echo "üöÄ Starting kernel compilation..."
        make O=out -j$(nproc) \
          CROSS_COMPILE=aarch64-none-linux-gnu-

        if [ -f "out/arch/arm64/boot/Image.gz-dtb" ]; then
          echo "‚úÖ Kernel built successfully!"
          ls -lh out/arch/arm64/boot/
        else
          echo "‚ùå Kernel build failed"
          find out -name "*.dtb" -o -name "Image*" | head -10
          exit 1
        fi

    - name: Package Kernel
      run: |
        cp ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz-dtb ${{ env.ANY_KERNEL_DIR }}/

    - name: Upload Kernel Zip
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_NAME }}
        path: ./*.zip
        retention-days: 30
