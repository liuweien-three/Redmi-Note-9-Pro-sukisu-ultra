name: Build Kernel for Gauguin

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
   
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
     
    - name: Download Official Linux Kernel
      run: |
        echo "ðŸ“¥ Downloading official Linux kernel..."

        wget -q --timeout=30 --tries=3 https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.325.tar.xz
        if [ $? -eq 0 ]; then
          tar -xf linux-4.19.325.tar.xz
          mv linux-4.19.325 kernel-source
          echo "âœ… Official kernel downloaded"
        else
          echo "âŒ Failed to download kernel"
          exit 1
        fi
       
    - name: Download SukiSU Files
      run: |
        echo "ðŸ“¥ Downloading SukiSU components..."
        mkdir -p sukisu-source

        wget -q --timeout=30 -O sukisu-source/sukisu_core.c https://raw.githubusercontent.com/ProjectSukisu/SukiSU/main/kernel/sukisu_core.c
        wget -q --timeout=30 -O sukisu-source/sukisu.h https://raw.githubusercontent.com/ProjectSukisu/SukiSU/main/kernel/sukisu.h
        wget -q --timeout=30 -O sukisu-source/Makefile https://raw.githubusercontent.com/ProjectSukisu/SukiSU/main/kernel/Makefile
        wget -q --timeout=30 -O sukisu-source/Kconfig https://raw.githubusercontent.com/ProjectSukisu/SukiSU/main/kernel/Kconfig
       
        echo "âœ… SukiSU files downloaded"
       
    - name: Install Dependencies
      run: |
        echo "ðŸ”§ Installing dependencies..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          libncurses-dev \
          bison flex \
          libssl-dev libelf-dev \
          bc \
          gcc-aarch64-linux-gnu
       
    - name: Build Kernel with SukiSU
      run: |
        echo "ðŸ—ï¸ Building kernel..."
        cd kernel-source

        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        make defconfig

        mkdir -p drivers/misc/sukisu
        cp ../sukisu-source/* drivers/misc/sukisu/
        echo 'obj-y += sukisu/' >> drivers/misc/Makefile

        make olddefconfig

        echo "Starting compilation..."
        make -j$(nproc)
       
        echo "âœ… Build completed"
       
    - name: Check Build Result
      run: |
        cd kernel-source
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "ðŸŽ‰ SUCCESS: Kernel image created!"
          ls -lh arch/arm64/boot/Image
          file arch/arm64/boot/Image
        else
          echo "âŒ FAILED: No kernel image found"
          echo "Available files in arch/arm64/boot/:"
          ls -la arch/arm64/boot/ 2>/dev/null || echo "Directory not found"
          exit 1
        fi
       
    - name: Upload Kernel Image
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: kernel-source/arch/arm64/boot/Image
        retention-days: 7
