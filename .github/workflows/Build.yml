name: Build Kernel for gauguinpro

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
   
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
     
    - name: Download Kernel Source
      run: |
        echo "üì• Downloading kernel source..."

        wget -q https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.325.tar.xz
        tar -xf linux-4.19.325.tar.xz
        mv linux-4.19.325 kernel-source
        echo "‚úÖ Kernel source ready"
       
    - name: Download SukiSU Source
      run: |
        echo "üì• Downloading SukiSU..."

        mkdir -p sukisu-source/kernel
        wget -q -O sukisu-source/kernel/sukisu_core.c https://raw.githubusercontent.com/ProjectSukisu/SukiSU/main/kernel/sukisu_core.c
        wget -q -O sukisu-source/kernel/sukisu.h https://raw.githubusercontent.com/ProjectSukisu/SukiSU/main/kernel/sukisu.h
        wget -q -O sukisu-source/kernel/Kconfig https://raw.githubusercontent.com/ProjectSukisu/SukiSU/main/kernel/Kconfig
        wget -q -O sukisu-source/kernel/Makefile https://raw.githubusercontent.com/ProjectSukisu/SukiSU/main/kernel/Makefile
        echo "‚úÖ SukiSU source ready"
       
    - name: Install Dependencies
      run: |
        echo "üîß Installing build dependencies..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          gcc-aarch64-linux-gnu
       
    - name: Build Kernel
      run: |
        echo "üèóÔ∏è Building kernel..."
        cd kernel-source

        make ARCH=arm64 defconfig

        mkdir -p drivers/misc/sukisu
        cp -r ../sukisu-source/kernel/* drivers/misc/sukisu/
        echo 'obj-y += sukisu/' >> drivers/misc/Makefile

        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
       
        make olddefconfig

        make -j$(nproc)
       
    - name: Check Results
      run: |
        cd kernel-source
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "üéâ SUCCESS: Kernel built!"
          ls -lh arch/arm64/boot/Image
        else
          echo "‚ùå Build failed"
          exit 1
        fi
       
    - name: Upload Kernel
      uses: actions/upload-artifact@v4
      with:
        name: kernel-image
        path: kernel-source/arch/arm64/boot/Image
