name: Build SukiSU Kernel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
   
    steps:
    - name: Checkout SukiSU source
      uses: actions/checkout@v3
      with:
        repository: SukiSU-Ultra/SukiSU-Ultra
        path: sukisu
       
    - name: Download kernel source via mirror
      run: |
        wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v4.x/linux-4.19.325.tar.xz
        tar -xf linux-4.19.325.tar.xz
        mv linux-4.19.325 kernel-src
       
    - name: Install dependencies
      run: |
        sudo sed -i 's/archive.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
        sudo sed -i 's/security.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
        sudo apt update
        sudo apt install -y build-essential libncurses-dev bison flex libssl-dev libelf-dev bc python3 git gcc-aarch64-linux-gnu
       
    - name: Apply SukiSU patches
      run: |
        cd kernel-src

        cp ../sukisu/arch/arm64/configs/gauguin_defconfig arch/arm64/configs/

        if [ -f "../sukisu/patch" ]; then
          patch -p1 < ../sukisu/patch
        fi
       
    - name: Build kernel
      run: |
        cd kernel-src
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
       
        make gauguin_defconfig
        make -j$(nproc) 2>&1 | tee build.log
       
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: sukisu-kernel
        path: |
          kernel-src/arch/arm64/boot/Image.gz
          kernel-src/arch/arm64/boot/dts/**/*.dtb
          kernel-src/.config
          kernel-src/build.log
